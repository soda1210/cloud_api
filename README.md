<p align="center">
  <a href="http://nestjs.com/" target="blank"><img src="https://nestjs.com/img/logo-small.svg" width="120" alt="Nest Logo" /></a>
</p>

[circleci-image]: https://img.shields.io/circleci/build/github/nestjs/nest/master?token=abc123def456
[circleci-url]: https://circleci.com/gh/nestjs/nest

  <p align="center">A progressive <a href="http://nodejs.org" target="_blank">Node.js</a> framework for building efficient and scalable server-side applications.</p>
    <p align="center">
<a href="https://www.npmjs.com/~nestjscore" target="_blank"><img src="https://img.shields.io/npm/v/@nestjs/core.svg" alt="NPM Version" /></a>
<a href="https://www.npmjs.com/~nestjscore" target="_blank"><img src="https://img.shields.io/npm/l/@nestjs/core.svg" alt="Package License" /></a>
<a href="https://www.npmjs.com/~nestjscore" target="_blank"><img src="https://img.shields.io/npm/dm/@nestjs/common.svg" alt="NPM Downloads" /></a>
<a href="https://circleci.com/gh/nestjs/nest" target="_blank"><img src="https://img.shields.io/circleci/build/github/nestjs/nest/master" alt="CircleCI" /></a>
<a href="https://discord.gg/G7Qnnhy" target="_blank"><img src="https://img.shields.io/badge/discord-online-brightgreen.svg" alt="Discord"/></a>
<a href="https://opencollective.com/nest#backer" target="_blank"><img src="https://opencollective.com/nest/backers/badge.svg" alt="Backers on Open Collective" /></a>
<a href="https://opencollective.com/nest#sponsor" target="_blank"><img src="https://opencollective.com/nest/sponsors/badge.svg" alt="Sponsors on Open Collective" /></a>
  <a href="https://paypal.me/kamilmysliwiec" target="_blank"><img src="https://img.shields.io/badge/Donate-PayPal-ff3f59.svg" alt="Donate us"/></a>
    <a href="https://opencollective.com/nest#sponsor"  target="_blank"><img src="https://img.shields.io/badge/Support%20us-Open%20Collective-41B883.svg" alt="Support us"></a>
  <a href="https://twitter.com/nestframework" target="_blank"><img src="https://img.shields.io/twitter/follow/nestframework.svg?style=social&label=Follow" alt="Follow us on Twitter"></a>
</p>
  <!--[![Backers on Open Collective](https://opencollective.com/nest/backers/badge.svg)](https://opencollective.com/nest#backer)
  [![Sponsors on Open Collective](https://opencollective.com/nest/sponsors/badge.svg)](https://opencollective.com/nest#sponsor)-->

## Description

[Nest](https://github.com/nestjs/nest) framework TypeScript starter repository.

## Project setup

```bash
$ npm install
```

## Compile and run the project

```bash
# development
$ npm run start

# watch mode
$ npm run start:dev

# production mode
$ npm run start:prod
```

## Run tests

```bash
# unit tests
$ npm run test

# e2e tests
$ npm run test:e2e

# test coverage
$ npm run test:cov
```

## Deployment

When you're ready to deploy your NestJS application to production, there are some key steps you can take to ensure it runs as efficiently as possible. Check out the [deployment documentation](https://docs.nestjs.com/deployment) for more information.

If you are looking for a cloud-based platform to deploy your NestJS application, check out [Mau](https://mau.nestjs.com), our official platform for deploying NestJS applications on AWS. Mau makes deployment straightforward and fast, requiring just a few simple steps:

```bash
$ npm install -g @nestjs/mau
$ mau deploy
```

With Mau, you can deploy your application in just a few clicks, allowing you to focus on building features rather than managing infrastructure.

## Resources

Check out a few resources that may come in handy when working with NestJS:

- Visit the [NestJS Documentation](https://docs.nestjs.com) to learn more about the framework.
- For questions and support, please visit our [Discord channel](https://discord.gg/G7Qnnhy).
- To dive deeper and get more hands-on experience, check out our official video [courses](https://courses.nestjs.com/).
- Deploy your application to AWS with the help of [NestJS Mau](https://mau.nestjs.com) in just a few clicks.
- Visualize your application graph and interact with the NestJS application in real-time using [NestJS Devtools](https://devtools.nestjs.com).
- Need help with your project (part-time to full-time)? Check out our official [enterprise support](https://enterprise.nestjs.com).
- To stay in the loop and get updates, follow us on [X](https://x.com/nestframework) and [LinkedIn](https://linkedin.com/company/nestjs).
- Looking for a job, or have a job to offer? Check out our official [Jobs board](https://jobs.nestjs.com).

## Support

Nest is an MIT-licensed open source project. It can grow thanks to the sponsors and support by the amazing backers. If you'd like to join them, please [read more here](https://docs.nestjs.com/support).

## Stay in touch

- Author - [Kamil MyÅ›liwiec](https://twitter.com/kammysliwiec)
- Website - [https://nestjs.com](https://nestjs.com/)
- Twitter - [@nestframework](https://twitter.com/nestframework)

## License

Nest is [MIT licensed](https://github.com/nestjs/nest/blob/master/LICENSE).


##  ç‰ˆæœ¬æ§åˆ¶
å„²èƒ½
  v2.0  å®Œæˆå„²èƒ½åˆæ­¥æ¶æ§‹ï¼Œswagger å¯ä»¥é †åˆ©é–‹å•Ÿ
  v2.1  å®Œæˆå„²èƒ½Request bodyæ¬„ä½ï¼Œå¯åœ¨Request bodyä¸­è¼¸å…¥è³‡æ–™ï¼Œä¸¦æª¢è¦–å°æ‡‰è³‡æ–™è¡¨è³‡æ–™æ˜¯å¦æ›´æ–°
  v2.2  èª¿æ•´å„²èƒ½Request bodyæ¬„ä½ï¼Œå·²æœ‰é è¨­è³‡æ–™ï¼Œæ¸¬è©¦æ™‚éœ€è¦èª¿æ•´å…§æ–‡è³‡æ–™æ•¸å€¼
  v2.3  å®Œæˆå¤ªé™½èƒ½Request bodyæ¬„ä½ï¼Œæ‰€æœ‰[ReceivedTime] çµ±ä¸€æ›´æ”¹ç‚º[Received_Time]
  v2.4  å¡ç‰‡å¾Œé¢è£œä¸Šç°¡çŸ­èªªæ˜èˆ‡æ ¼å¼æ’°å¯«
  v2.5  å„é …å‘½åæ–¹å¼åŠç¶²å€æ›´æ”¹


# Solar Equipment Generation API

é€™æ˜¯ä¸€å€‹åŸºæ–¼ NestJS é–‹ç™¼çš„å¤ªé™½èƒ½è¨­å‚™ç™¼é›»è³‡æ–™ç®¡ç† API ç³»çµ±ï¼Œæä¾› RESTful API ä»‹é¢ä¾†æ¥æ”¶å’Œç®¡ç†å¤šå€‹æ¡ˆå ´çš„å¤ªé™½èƒ½è¨­å‚™ç™¼é›»è³‡æ–™ã€‚

## ä¸»è¦åŠŸèƒ½

- âœ… æ¥æ”¶å–®ç­†å¤ªé™½èƒ½è¨­å‚™ç™¼é›»è³‡æ–™
- âœ… æ‰¹æ¬¡æ¥æ”¶å¤šç­†ç™¼é›»è³‡æ–™
- âœ… æŸ¥è©¢ç™¼é›»è³‡æ–™ï¼ˆæ”¯æ´åˆ†é å’Œç¯©é¸ï¼‰
- âœ… å–å¾—ç™¼é›»çµ±è¨ˆè³‡æ–™
- âœ… æ ¹æ“šè¨­å‚™ ID æŸ¥è©¢æœ€æ–°è³‡æ–™
- âœ… API Key èªè­‰æ©Ÿåˆ¶
- âœ… è³‡æ–™é©—è­‰å’ŒéŒ¯èª¤è™•ç†
- âœ… Swagger API æ–‡ä»¶

## æŠ€è¡“æ£§

- **æ¡†æ¶**: NestJS
- **è³‡æ–™åº«**: Microsoft SQL Server
- **ORM**: TypeORM
- **é©—è­‰**: Class-validator
- **æ–‡ä»¶**: Swagger/OpenAPI
- **èªè¨€**: TypeScript

## å®‰è£èˆ‡è¨­å®š

### 1. å®‰è£ä¾è³´å¥—ä»¶

```bash
npm install
```

### 2. ç’°å¢ƒè®Šæ•¸è¨­å®š

è¤‡è£½ `.env` æª”æ¡ˆä¸¦è¨­å®šç›¸é—œåƒæ•¸ï¼š

```bash
# æ‡‰ç”¨ç¨‹å¼è¨­å®š
NODE_ENV=development
PORT=3000

# è³‡æ–™åº«è¨­å®š
DB_HOST=localhost
DB_PORT=1433
DB_USERNAME=your_username
DB_PASSWORD=your_password
DB_DATABASE=your_database_name
DB_ENCRYPT=true
DB_TRUST_CERT=true

# API é‡‘é‘°è¨­å®š
API_KEY=your-super-secret-api-key-here

# CORS è¨­å®š
ALLOWED_ORIGINS=http://localhost:3000,http://localhost:3001
```

### 3. è³‡æ–™åº«è¨­å®š

ç¢ºä¿æ‚¨çš„ SQL Server è³‡æ–™åº«ä¸­å·²å»ºç«‹ `Solar_equipment_generation_his` è¡¨æ ¼ï¼š

```sql
CREATE TABLE [dbo].[Solar_equipment_generation_his](
    [History_ID] [int] IDENTITY(1,1) NOT NULL,
    [Generation_ID] [int] NOT NULL,
    [Solar_site_ID] [int] NOT NULL,
    [Location_ID] [int] NOT NULL,
    [Equipment_ID] [int] NOT NULL,
    [Data_time] [datetime] NOT NULL,
    [ReceivedTime] [datetime] NOT NULL,
    [Serial_number] [nvarchar](max) NULL,
    [Generation_P_daily] [decimal](8, 2) NULL,
    [Generation_P_all] [decimal](12, 0) NULL,
    [Sunshine_meter] [decimal](7, 3) NULL,
    [Sunshine_meter_avg] [decimal](5, 3) NULL,
    [Error_code] [nvarchar](max) NULL,
    PRIMARY KEY CLUSTERED ([History_ID] ASC)
);
```

## å•Ÿå‹•æ‡‰ç”¨ç¨‹å¼

### é–‹ç™¼æ¨¡å¼

```bash
npm run start:dev
```

### ç”Ÿç”¢æ¨¡å¼

```bash
npm run build
npm run start:prod
```

æ‡‰ç”¨ç¨‹å¼å°‡åœ¨ `http://localhost:3000` å•Ÿå‹•

## API æ–‡ä»¶

å•Ÿå‹•æ‡‰ç”¨ç¨‹å¼å¾Œï¼Œå¯é€éä»¥ä¸‹ç¶²å€æŸ¥çœ‹ Swagger API æ–‡ä»¶ï¼š

```
http://localhost:3000/api-docs
```

## API ç«¯é»

æ‰€æœ‰ API éƒ½éœ€è¦åœ¨ Header ä¸­åŒ…å« `X-API-Key` é€²è¡Œèªè­‰ã€‚

### åŸºç¤è·¯å¾‘

```
http://localhost:3000/api/v1/solar-equipment
```

### ä¸»è¦ç«¯é»

#### 1. å»ºç«‹å–®ç­†è³‡æ–™

```http
POST /api/v1/solar-equipment
Content-Type: application/json
X-API-Key: your-api-key

{
  "generationId": 1001,
  "solarSiteId": 2001,
  "locationId": 3001,
  "equipmentId": 4001,
  "dataTime": "2024-01-15T10:30:00.000Z",
  "serialNumber": "SN123456789",
  "generationPDaily": 25.75,
  "generationPAll": 15000,
  "sunshineMeter": 8.523,
  "sunshineMeterAvg": 7.852,
  "errorCode": null
}
```

#### 2. æ‰¹æ¬¡å»ºç«‹è³‡æ–™

```http
POST /api/v1/solar-equipment/batch
Content-Type: application/json
X-API-Key: your-api-key

{
  "data": [
    {
      "generationId": 1001,
      "solarSiteId": 2001,
      "locationId": 3001,
      "equipmentId": 4001,
      "dataTime": "2024-01-15T10:30:00.000Z",
      "serialNumber": "SN123456789",
      "generationPDaily": 25.75,
      "generationPAll": 15000,
      "sunshineMeter": 8.523,
      "sunshineMeterAvg": 7.852
    }
  ]
}
```

#### 3. æŸ¥è©¢è³‡æ–™

```http
GET /api/v1/solar-equipment?page=1&limit=10&solarSiteId=2001
X-API-Key: your-api-key
```

æŸ¥è©¢åƒæ•¸ï¼š
- `page`: é æ•¸ï¼ˆé è¨­ï¼š1ï¼‰
- `limit`: æ¯é ç­†æ•¸ï¼ˆé è¨­ï¼š10ï¼Œæœ€å¤§ï¼š100ï¼‰
- `generationId`: ç™¼é›»æ©Ÿ ID
- `solarSiteId`: å¤ªé™½èƒ½æ¡ˆå ´ ID
- `locationId`: ä½ç½® ID
- `equipmentId`: è¨­å‚™ ID
- `startDate`: é–‹å§‹æ—¥æœŸ
- `endDate`: çµæŸæ—¥æœŸ
- `serialNumber`: è¨­å‚™åºè™Ÿ

#### 4. å–å¾—çµ±è¨ˆè³‡æ–™

```http
GET /api/v1/solar-equipment/statistics?solarSiteId=2001
X-API-Key: your-api-key
```

#### 5. å–å¾—è¨­å‚™æœ€æ–°è³‡æ–™

```http
GET /api/v1/solar-equipment/equipment/4001/latest
X-API-Key: your-api-key
```

#### 6. å–å¾—å–®ç­†è³‡æ–™

```http
GET /api/v1/solar-equipment/1
X-API-Key: your-api-key
```

## éŒ¯èª¤è™•ç†

API éµå¾ªæ¨™æº–çš„ HTTP ç‹€æ…‹ç¢¼ï¼š

- `200`: æˆåŠŸ
- `201`: å»ºç«‹æˆåŠŸ
- `400`: è«‹æ±‚éŒ¯èª¤ï¼ˆè³‡æ–™é©—è­‰å¤±æ•—ï¼‰
- `401`: èªè­‰å¤±æ•—ï¼ˆAPI Key éŒ¯èª¤ï¼‰
- `404`: è³‡æºä¸å­˜åœ¨
- `500`: ä¼ºæœå™¨å…§éƒ¨éŒ¯èª¤

éŒ¯èª¤å›æ‡‰æ ¼å¼ï¼š

```json
{
  "statusCode": 400,
  "message": "é©—è­‰å¤±æ•—",
  "error": "Bad Request"
}
```

## è³‡æ–™é©—è­‰

API æœƒè‡ªå‹•é©—è­‰è¼¸å…¥è³‡æ–™ï¼Œç¢ºä¿ï¼š

- å¿…å¡«æ¬„ä½ä¸å¯ç‚ºç©º
- æ•¸å€¼æ¬„ä½æ ¼å¼æ­£ç¢º
- æ—¥æœŸæ ¼å¼ç¬¦åˆ ISO 8601 æ¨™æº–
- æ•¸å€¼ç¯„åœåœ¨åˆç†å€é–“å…§

## å®‰å…¨æ€§

- æ‰€æœ‰ API éƒ½éœ€è¦ API Key èªè­‰
- ä½¿ç”¨ Helmet ä¸­é–“ä»¶å¢å¼·å®‰å…¨æ€§
- æ”¯æ´ CORS è·¨åŸŸè«‹æ±‚æ§åˆ¶
- è³‡æ–™é©—è­‰é˜²æ­¢æ³¨å…¥æ”»æ“Š

## æ—¥èªŒè¨˜éŒ„

ç³»çµ±æœƒè¨˜éŒ„ï¼š
- API è«‹æ±‚å’Œå›æ‡‰
- è³‡æ–™åº«æ“ä½œ
- éŒ¯èª¤è¨Šæ¯å’Œå †ç–Šè¿½è¹¤
- é‡è¦æ¥­å‹™æ“ä½œ

## æ¸¬è©¦

```bash
# å–®å…ƒæ¸¬è©¦
npm run test

# ç«¯å°ç«¯æ¸¬è©¦
npm run test:e2e

# æ¸¬è©¦æ¶µè“‹ç‡
npm run test:cov
```

## éƒ¨ç½²

### windows ç’°å¢ƒ npm å¥—ä»¶

ğŸ“¦ å®‰è£å¥—ä»¶ï¼ˆå…¨åŸŸï¼‰
``` powershell
npm install -g pm2
npm install -g pm2-windows-startup
```
âš™ï¸ è¨»å†Šé–‹æ©Ÿå•Ÿå‹•ï¼ˆéœ€è¦æ¬Šé™ï¼‰
``` powershell
pm2-startup install
```

### windows IIS åå‘ä»£ç†è¨­å®š
![image](./image/step1.png)
![image](./image/step2.png)
![image](./image/step3.png)



### Docker éƒ¨ç½²ï¼ˆå¯é¸ï¼‰

å¯ä»¥å»ºç«‹ Dockerfile ä¾†å®¹å™¨åŒ–æ‡‰ç”¨ç¨‹å¼ï¼š

```dockerfile
FROM node:18-alpine
WORKDIR /app
COPY package*.json ./
RUN npm ci --only=production
COPY dist ./dist
EXPOSE 3000
CMD ["node", "dist/main"]
```

### ç’°å¢ƒè®Šæ•¸æª¢æŸ¥æ¸…å–®

éƒ¨ç½²å‰ç¢ºèªä»¥ä¸‹ç’°å¢ƒè®Šæ•¸å·²æ­£ç¢ºè¨­å®šï¼š

- [ ] `DB_HOST` - è³‡æ–™åº«ä¸»æ©Ÿä½å€
- [ ] `DB_USERNAME` - è³‡æ–™åº«ä½¿ç”¨è€…åç¨±
- [ ] `DB_PASSWORD` - è³‡æ–™åº«å¯†ç¢¼
- [ ] `DB_DATABASE` - è³‡æ–™åº«åç¨±
- [ ] `API_KEY` - API èªè­‰é‡‘é‘°
- [ ] `NODE_ENV` - ç’°å¢ƒæ¨¡å¼ï¼ˆproductionï¼‰

## æˆæ¬Š

æ­¤å°ˆæ¡ˆåƒ…ä¾›å…§éƒ¨ä½¿ç”¨ã€‚

## æ”¯æ´

å¦‚æœ‰å•é¡Œæˆ–éœ€è¦å”åŠ©ï¼Œè«‹è¯ç¹«é–‹ç™¼åœ˜éšŠã€‚